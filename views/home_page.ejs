<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resto Connect</title>
    <link rel="stylesheet" href="/css/home_page_styles.css">

    <style>



        .none{
            display: none;
        }
        
        body{
            visibility: visible;
        }
        .visibilityHidden{
            visibility: hidden;
        }

    </style>
</head>
<body>
    <% if(!login) { %>
    <div class="back_ground">
        <div class="overlay">
    <nav class="nav-bar">
        <div class="logo">Resto<span>Connect</span></div>
       
        <div class="menu-toggle">&#9776;</div>
    </nav>
    
    <div class="hero">

        <div class="hero_text_container">
            <ul class="hero_text_title">
                <li><span>Resto </span></li>
                <li><span> &nbsp; </span></li>
                <li><span>Connect</span></li>
            </ul>
            
            <div class="sub_text">
                Discover the best food & dining experiences
            </div>

                <div>
                <a href="/LoginPage" id="login_registerlink" class="comic-button ">Login/Register</a>
            </div>
            
        </div>       
    </div>
    </div>
</div>
<% } else { %>

    <nav class="nav-bar" style="position: sticky; top: 0px; z-index: 1000; background-color: black;">
        <div class="logo">Resto <span>Connect</span></div>
        <div class="search-bar">
            <form action="/" method="get">
                <select class="location-dropdown" name="city_option_home">
                    <option value="Tirupati" <%= (typeof city_option_home !== 'undefined' && city_option_home === 'Tirupati') ? 'selected' : '' %>>Tirupati</option>
                    <option value="Chennai" <%= (typeof city_option_home !== 'undefined' && city_option_home === 'Chennai') ? 'selected' : '' %>>Chennai</option>
                    <option value="Hyderabad" <%= (typeof city_option_home !== 'undefined' && city_option_home === 'Hyderabad') ? 'selected' : '' %>>Hyderabad</option>
                </select>
                <input type="text" placeholder="Search for restaurant, cuisine, or dish" id="search-input" name="name_resaurent" required>
                <button type="button" class="comic-button" id="clear-search">Clear</button>
            </form>
        </div>

        <ul class="nav-links" >
            <% if (user === 'customer') { %>
                <li><a href="/customer/customerDashboard">Dashboard</a></li>
            <% } else if (user === 'staff') { %>
                <li><a href="/staff/dashboard">Dashboard</a></li>
            <% } else if (user === 'admin') { %>
                <li><a href="/admin/dashboard">Dashboard</a></li>
            <% } else if (user === 'owner') { %>
                <li><a href="/owner/dashboard">Dashboard</a></li>
            <% } %> 
            <li><a href="/logout">logout</a></li>             
        </ul>
        <div class="menu-toggle">&#9776;</div>
    </nav>
    
    <!-- Restaurants injected here by AJAX -->
    <!-- <div class="restaurants" id="restaurants-container">
        <p>Loading restaurants...</p>
    </div> -->

    <div id="restaurants-container" class="restaurants">
    <% if(arr.length === 0) { %>
        <p>Loading restaurants...</p>
    <% } else { %>
        <% arr.forEach(function(restaurant) { %>
            <a href="/menu/<%= restaurant._id %>">
                <div class="restaurant">
                    <img src="<%= restaurant.image %>" alt="<%= restaurant.name %>" height="100" width="100">
                    <p class="restaurant-name"><%= restaurant.name %></p>
                    <p class="restaurant-rating">Rating: <%= restaurant.rating %> ⭐</p>
                </div>
            </a>
        <% }); %>
    <% } %>
</div>

<% } %>

<footer>
    <p>&copy; 2025 Resto Connect. All rights reserved.</p>
</footer>
    
<script>
    // Menu toggle
    document.querySelector(".menu-toggle").addEventListener("click", function() {
        document.querySelector(".nav-links").classList.toggle("active");
    });

    const searchInput = document.getElementById('search-input');
    const clearButton = document.getElementById('clear-search');
    const container = document.getElementById("restaurants-container");

    // Add class 'restaurant-link' to server-rendered restaurants for search
    const serverRestaurants = container.querySelectorAll('a');
    serverRestaurants.forEach(link => link.classList.add('restaurant-link'));

    // Function to filter restaurants
    function applySearch() {
        const query = searchInput.value.toLowerCase().trim();
        const restaurantLinks = container.querySelectorAll('.restaurant-link');

        restaurantLinks.forEach(link => {
            const name = link.querySelector('.restaurant-name').innerText.toLowerCase();
            link.style.display = name.includes(query) ? 'block' : 'none';
        });
    }

    if (searchInput) searchInput.addEventListener('input', applySearch);
    if (clearButton) {
        clearButton.addEventListener('click', function() {
            searchInput.value = '';
            applySearch();
        });
    }

    // Fetch restaurants via AJAX if logged in
    const isLoggedIn = "<%= login ? 'true' : 'false' %>";
    if (isLoggedIn === "true") {
        async function loadRestaurants() {
            try {
                const response = await fetch("/api/restaurants");
                if (!response.ok) throw new Error("Failed to fetch restaurants");

                const restaurants = await response.json();

                // Clear container first
                container.innerHTML = "";
                if (restaurants.length === 0) {
                    container.innerHTML = "<p>No restaurants found.</p>";
                    return;
                }

                restaurants.forEach(r => {
                    const link = document.createElement("a");
                    link.href = `/menu/${r._id}`;
                    link.classList.add("restaurant-link");
                    link.innerHTML = `
                        <div class="restaurant">
                            <img src="${r.image || 'https://via.placeholder.com/100'}" alt="${r.name}" height="100" width="100">
                            <p class="restaurant-name">${r.name}</p>
                            <p class="restaurant-rating">Rating: ${r.rating || 'N/A'} ⭐</p>
                        </div>
                    `;
                    container.appendChild(link);
                });

                applySearch(); // apply search immediately
            } catch (error) {
                console.error("Error loading restaurants:", error);
                container.innerHTML = "<p>Error loading restaurants.</p>";
            }
        }

        window.addEventListener("DOMContentLoaded", loadRestaurants);
    }
</script>

</body>
</html>
